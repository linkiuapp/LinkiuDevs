<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Store Configuration Step</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Basic validation styles */
        .form-input.error { @apply border-red-500; }
        .form-input.valid { @apply border-green-500; }
        .form-input.validating { @apply border-blue-500; }
        .field-error { @apply text-red-600 text-sm mt-1; }
        .field-hint { @apply text-gray-500 text-sm mt-1; }
        .spinner { @apply w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin; }
        .suggestion-btn { @apply px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors mr-2 mb-1; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-accent rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Test Store Configuration Step</h1>
        
        <!-- Mock form data for testing -->
        <div 
            x-data="storeConfigurationStep({
                formData: {
                    name: '',
                    slug: '',
                    email: '',
                    phone: '',
                    description: '',
                    status: 'active'
                },
                template: {
                    id: 'complete',
                    name: 'Tienda Completa'
                },
                plan: {
                    id: 1,
                    name: 'Plan Premium',
                    allow_custom_slug: true,
                    max_products: 1000,
                    max_categories: 50,
                    max_admins: 5,
                    support_level: 'premium'
                },
                errors: {}
            })"
            class="store-configuration-step"
        >
            <!-- Step Header -->
            <div class="step-header mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Configuraci√≥n de la Tienda</h2>
                <p class="text-gray-600">Define los datos b√°sicos y configuraci√≥n de tu tienda</p>
            </div>

            <!-- Form Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Store Name -->
                <div class="form-group col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                        <span x-text="getStoreNameLabel()"></span>
                        <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="name"
                        name="name"
                        x-model="formData.name"
                        @input="onStoreNameChange($event.target.value)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        :class="{ 'error': hasFieldError('name') }"
                        :placeholder="getStoreNamePlaceholder()"
                        required
                    >
                    <div x-show="hasFieldError('name')" class="field-error">
                        <span x-text="getFieldError('name')"></span>
                    </div>
                    <div x-show="getFieldHint('name')" class="field-hint">
                        <span x-text="getFieldHint('name')"></span>
                    </div>
                </div>

                <!-- Store Slug/URL -->
                <div class="form-group col-span-2">
                    <label for="slug" class="block text-sm font-medium text-gray-700 mb-2">
                        URL de la Tienda
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="flex border border-gray-300 rounded-md overflow-hidden focus-within:ring-blue-500 focus-within:border-blue-500">
                        <div class="bg-gray-50 px-3 py-2 border-r border-gray-300 flex items-center">
                            <span class="text-gray-500">https://linkiu.bio/</span>
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="slug"
                                name="slug"
                                x-model="formData.slug"
                                @input="onSlugChange($event.target.value)"
                                class="w-full px-3 py-2 border-0 focus:ring-0"
                                :class="{ 
                                    'error': hasFieldError('slug'),
                                    'validating': isValidating('slug'),
                                    'valid': isFieldValid('slug'),
                                    'bg-gray-100 cursor-not-allowed': !canEditSlug()
                                }"
                                :placeholder="getSlugPlaceholder()"
                                :readonly="!canEditSlug()"
                                required
                            >
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                                <button 
                                    type="button"
                                    x-show="canEditSlug() && formData.name"
                                    @click="generateSlugFromName()"
                                    class="text-gray-400 hover:text-gray-600 p-1"
                                    title="Generar desde el nombre"
                                >
                                    üîÑ
                                </button>
                                <div class="validation-indicator">
                                    <div x-show="isValidating('slug')" class="spinner"></div>
                                    <div x-show="isFieldValid('slug')" class="text-green-600">‚úì</div>
                                    <div x-show="hasFieldError('slug')" class="text-red-600">‚úó</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Slug Status Messages -->
                    <div x-show="hasFieldError('slug')" class="field-error">
                        <span x-text="getFieldError('slug')"></span>
                    </div>
                    <div x-show="getSlugSuggestions().length > 0" class="mt-2">
                        <p class="text-sm text-gray-600 mb-2">Sugerencias disponibles:</p>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="suggestion in getSlugSuggestions()" :key="suggestion">
                                <button 
                                    type="button"
                                    @click="selectSlugSuggestion(suggestion)"
                                    class="suggestion-btn"
                                >
                                    <span x-text="suggestion"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div x-show="!canEditSlug()" class="mt-2">
                        <div class="flex items-center text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-md p-3">
                            <span class="mr-2">‚ÑπÔ∏è</span>
                            <span>El plan seleccionado genera la URL autom√°ticamente. Actualiza a un plan superior para personalizar la URL.</span>
                        </div>
                    </div>
                </div>

                <!-- Store Email -->
                <div class="form-group" x-show="shouldShowField('email')">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2" :class="{ 'required': isFieldRequired('email') }">
                        Email de Contacto
                        <span x-show="isFieldRequired('email')" class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="email" 
                            id="email"
                            name="email"
                            x-model="formData.email"
                            @input="debounceValidation('email', $event.target.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            :class="{ 
                                'error': hasFieldError('email'),
                                'validating': isValidating('email'),
                                'valid': isFieldValid('email')
                            }"
                            placeholder="contacto@mitienda.com"
                            :required="isFieldRequired('email')"
                        >
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <div x-show="isValidating('email')" class="spinner"></div>
                            <div x-show="isFieldValid('email')" class="text-green-600">‚úì</div>
                            <div x-show="hasFieldError('email')" class="text-red-600">‚úó</div>
                        </div>
                    </div>
                    <div x-show="hasFieldError('email')" class="field-error">
                        <span x-text="getFieldError('email')"></span>
                    </div>
                </div>

                <!-- Store Phone -->
                <div class="form-group" x-show="shouldShowField('phone')">
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2" :class="{ 'required': isFieldRequired('phone') }">
                        Tel√©fono de Contacto
                        <span x-show="isFieldRequired('phone')" class="text-red-500">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="phone"
                        name="phone"
                        x-model="formData.phone"
                        @input="validatePhone($event.target.value)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        :class="{ 'error': hasFieldError('phone') }"
                        placeholder="+57 300 123 4567"
                        :required="isFieldRequired('phone')"
                    >
                    <div x-show="hasFieldError('phone')" class="field-error">
                        <span x-text="getFieldError('phone')"></span>
                    </div>
                </div>

                <!-- Store Description -->
                <div class="form-group col-span-2" x-show="shouldShowField('description')">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n de la Tienda</label>
                    <textarea 
                        id="description"
                        name="description"
                        x-model="formData.description"
                        @input="validateDescription($event.target.value)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                        :class="{ 'error': hasFieldError('description') }"
                        rows="4"
                        placeholder="Describe brevemente tu tienda, productos o servicios..."
                        maxlength="1000"
                    ></textarea>
                    <div class="text-right text-sm text-gray-500 mt-1">
                        <span x-text="(formData.description || '').length"></span>/1000 caracteres
                    </div>
                    <div x-show="hasFieldError('description')" class="field-error">
                        <span x-text="getFieldError('description')"></span>
                    </div>
                </div>

                <!-- Store Status -->
                <div class="form-group" x-show="shouldShowField('status')">
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                        Estado Inicial
                        <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="status"
                        name="status"
                        x-model="formData.status"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        :class="{ 'error': hasFieldError('status') }"
                        required
                    >
                        <option value="active">Activa</option>
                        <option value="inactive">Inactiva</option>
                    </select>
                    <div x-show="hasFieldError('status')" class="field-error">
                        <span x-text="getFieldError('status')"></span>
                    </div>
                    <div class="field-hint">
                        <span>Las tiendas activas estar√°n disponibles inmediatamente</span>
                    </div>
                </div>
            </div>

            <!-- Plan Features Summary -->
            <div x-show="plan" class="mb-8">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h4 class="font-medium text-blue-900 mb-4 flex items-center">
                        ‚öôÔ∏è Caracter√≠sticas del Plan Seleccionado
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="flex items-center space-x-3" x-show="plan?.max_products">
                            <div class="text-blue-600">üì¶</div>
                            <div>
                                <div class="text-sm font-medium text-blue-900">Productos</div>
                                <div class="text-sm text-blue-700" x-text="getPlanFeatureValue('max_products')"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3" x-show="plan?.max_categories">
                            <div class="text-blue-600">üìÅ</div>
                            <div>
                                <div class="text-sm font-medium text-blue-900">Categor√≠as</div>
                                <div class="text-sm text-blue-700" x-text="getPlanFeatureValue('max_categories')"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3" x-show="plan?.max_admins">
                            <div class="text-blue-600">üë•</div>
                            <div>
                                <div class="text-sm font-medium text-blue-900">Administradores</div>
                                <div class="text-sm text-blue-700" x-text="getPlanFeatureValue('max_admins')"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="text-blue-600">üîó</div>
                            <div>
                                <div class="text-sm font-medium text-blue-900">URL Personalizada</div>
                                <div class="text-sm text-blue-700" x-text="plan?.allow_custom_slug ? 'Permitida' : 'No disponible'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3" x-show="plan?.support_level">
                            <div class="text-blue-600">üí¨</div>
                            <div>
                                <div class="text-sm font-medium text-blue-900">Soporte</div>
                                <div class="text-sm text-blue-700" x-text="getPlanFeatureValue('support_level')"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Store Preview -->
            <div x-show="isStepValid()" class="mb-8">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h4 class="font-medium text-gray-900 mb-4 flex items-center">
                        üëÅÔ∏è Vista Previa de la Tienda
                    </h4>
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <div class="text-lg font-semibold text-gray-900" x-text="formData.name || 'Nombre de la Tienda'"></div>
                            <div class="flex items-center text-sm text-blue-600">
                                üîó <span x-text="getStoreUrl()"></span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div x-show="formData.description" class="text-gray-600 text-sm">
                                <p x-text="formData.description"></p>
                            </div>
                            <div class="flex flex-wrap gap-4">
                                <div x-show="formData.email" class="flex items-center text-sm text-gray-600">
                                    ‚úâÔ∏è <span x-text="formData.email"></span>
                                </div>
                                <div x-show="formData.phone" class="flex items-center text-sm text-gray-600">
                                    üìû <span x-text="formData.phone"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug Info -->
            <div class="mt-8 p-4 bg-gray-100 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-2">Debug Info:</h4>
                <div class="text-sm text-gray-600 space-y-1">
                    <div>Step Valid: <span x-text="isStepValid()"></span></div>
                    <div>Can Edit Slug: <span x-text="canEditSlug()"></span></div>
                    <div>User Modified Slug: <span x-text="userModifiedSlug"></span></div>
                    <div>Form Data: <pre x-text="JSON.stringify(formData, null, 2)"></pre></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Include the store configuration step component
        function storeConfigurationStep(config = {}) {
            return {
                // Component state
                formData: config.formData || {
                    name: '',
                    slug: '',
                    email: '',
                    phone: '',
                    description: '',
                    status: 'active'
                },
                template: config.template || null,
                plan: config.plan || null,
                errors: config.errors || {},
                
                // Validation state
                validationEngine: null,
                validationHelpers: null,
                validationErrors: [],
                fieldValidationStatus: {},
                slugSuggestions: [],
                
                // UI state
                isValidating: {},
                userModifiedSlug: false,
                
                // Debounce timers
                debounceTimers: {},

                /**
                 * Initialize component
                 */
                init() {
                    this.setupSlugGeneration();
                    this.setupFieldWatchers();
                },

                /**
                 * Setup automatic slug generation
                 */
                setupSlugGeneration() {
                    // Watch for name changes to auto-generate slug
                    this.$watch('formData.name', (newName) => {
                        if (!this.userModifiedSlug && newName && this.canEditSlug()) {
                            this.formData.slug = this.generateSlugFromName(newName);
                        }
                    });
                },

                /**
                 * Setup field watchers for validation
                 */
                setupFieldWatchers() {
                    // Watch slug changes
                    this.$watch('formData.slug', (newSlug) => {
                        if (newSlug !== this.generateSlugFromName(this.formData.name)) {
                            this.userModifiedSlug = true;
                        }
                    });
                },

                /**
                 * Handle store name input change
                 */
                onStoreNameChange(value) {
                    this.formData.name = value;
                    this.clearFieldError('name');
                    
                    // Basic validation
                    if (value.trim() && value.length < 3) {
                        this.setFieldError('name', 'El nombre debe tener al menos 3 caracteres');
                    }
                },

                /**
                 * Handle slug input change
                 */
                onSlugChange(value) {
                    this.formData.slug = value;
                    this.clearFieldError('slug');
                    this.slugSuggestions = [];
                    
                    if (value !== this.generateSlugFromName(this.formData.name)) {
                        this.userModifiedSlug = true;
                    }
                    
                    // Basic validation
                    if (value && !/^[a-z0-9-]+$/.test(value)) {
                        this.setFieldError('slug', 'Solo se permiten letras min√∫sculas, n√∫meros y guiones');
                    }
                },

                /**
                 * Generate slug from store name
                 */
                generateSlugFromName(name = '') {
                    if (!name) return '';
                    
                    return name
                        .toLowerCase()
                        .trim()
                        // Replace accented characters
                        .replace(/[√°√†√§√¢ƒÅ√£]/g, 'a')
                        .replace(/[√©√®√´√™ƒì]/g, 'e')
                        .replace(/[√≠√¨√Ø√Æƒ´]/g, 'i')
                        .replace(/[√≥√≤√∂√¥≈ç√µ]/g, 'o')
                        .replace(/[√∫√π√º√ª≈´]/g, 'u')
                        .replace(/[√±]/g, 'n')
                        .replace(/[√ß]/g, 'c')
                        // Replace spaces and special characters with hyphens
                        .replace(/[^a-z0-9]+/g, '-')
                        // Remove multiple consecutive hyphens
                        .replace(/-+/g, '-')
                        // Remove leading and trailing hyphens
                        .replace(/^-+|-+$/g, '');
                },

                /**
                 * Generate slug from current name
                 */
                generateSlugFromName() {
                    if (this.formData.name && this.canEditSlug()) {
                        this.formData.slug = this.generateSlugFromName(this.formData.name);
                        this.userModifiedSlug = false;
                    }
                },

                /**
                 * Check if slug can be edited based on plan
                 */
                canEditSlug() {
                    return !this.plan || this.plan.allow_custom_slug !== false;
                },

                /**
                 * Debounced validation (mock)
                 */
                debounceValidation(fieldName, value) {
                    // Mock validation for demo
                    console.log(`Validating ${fieldName}: ${value}`);
                },

                /**
                 * Validate phone number format
                 */
                validatePhone(phone) {
                    if (!phone) return;
                    
                    // Basic phone validation for Colombian numbers
                    const phoneRegex = /^(\+57\s?)?[0-9\s\-\(\)]{7,15}$/;
                    
                    if (!phoneRegex.test(phone)) {
                        this.setFieldError('phone', 'Formato de tel√©fono inv√°lido');
                    } else {
                        this.clearFieldError('phone');
                    }
                },

                /**
                 * Validate description length
                 */
                validateDescription(description) {
                    if (description && description.length > 1000) {
                        this.setFieldError('description', 'La descripci√≥n no puede exceder 1000 caracteres');
                    } else {
                        this.clearFieldError('description');
                    }
                },

                /**
                 * Check if field should be shown based on template/plan
                 */
                shouldShowField(fieldName) {
                    if (!this.template) return true;

                    const fieldVisibility = {
                        'email': true,
                        'phone': this.template.id !== 'basic',
                        'description': this.template.id !== 'basic',
                        'status': true
                    };

                    return fieldVisibility[fieldName] !== false;
                },

                /**
                 * Check if field is required based on template/plan
                 */
                isFieldRequired(fieldName) {
                    if (!this.template) return false;

                    const requiredFields = {
                        'email': this.template.id === 'enterprise',
                        'phone': this.template.id === 'enterprise',
                        'description': false,
                        'status': true
                    };

                    return requiredFields[fieldName] === true;
                },

                /**
                 * Get store name label based on template
                 */
                getStoreNameLabel() {
                    if (this.template?.id === 'enterprise') {
                        return 'Nombre de la Empresa';
                    }
                    return 'Nombre de la Tienda';
                },

                /**
                 * Get store name placeholder based on template
                 */
                getStoreNamePlaceholder() {
                    if (this.template?.id === 'enterprise') {
                        return 'Ej: Empresa ABC S.A.S.';
                    }
                    return 'Ej: Mi Tienda Online';
                },

                /**
                 * Get slug placeholder
                 */
                getSlugPlaceholder() {
                    if (this.template?.id === 'enterprise') {
                        return 'empresa-abc';
                    }
                    return 'mi-tienda-online';
                },

                /**
                 * Get store URL preview
                 */
                getStoreUrl() {
                    const baseUrl = 'https://linkiu.bio';
                    const slug = this.formData.slug || 'mi-tienda';
                    return `${baseUrl}/${slug}`;
                },

                /**
                 * Get plan feature value for display
                 */
                getPlanFeatureValue(feature) {
                    if (!this.plan || !this.plan[feature]) return 'N/A';
                    
                    const value = this.plan[feature];
                    
                    if (feature.startsWith('max_') && value === -1) {
                        return 'Ilimitado';
                    }
                    
                    if (feature === 'support_level') {
                        const levels = {
                            'basic': 'B√°sico',
                            'standard': 'Est√°ndar',
                            'premium': 'Premium'
                        };
                        return levels[value] || value;
                    }
                    
                    return value;
                },

                /**
                 * Validation state management
                 */
                setFieldError(fieldName, message) {
                    this.errors[fieldName] = message;
                },

                clearFieldError(fieldName) {
                    delete this.errors[fieldName];
                },

                hasFieldError(fieldName) {
                    return !!this.errors[fieldName];
                },

                getFieldError(fieldName) {
                    return this.errors[fieldName] || '';
                },

                isValidating(fieldName) {
                    return !!this.isValidating[fieldName];
                },

                isFieldValid(fieldName) {
                    return this.fieldValidationStatus[fieldName] === true;
                },

                getFieldHint(fieldName) {
                    const hints = {
                        'name': this.template?.id === 'enterprise' ? 'Nombre legal de la empresa' : 'Nombre que aparecer√° en tu tienda',
                        'slug': this.canEditSlug() ? 'URL √∫nica para tu tienda (solo letras, n√∫meros y guiones)' : null
                    };
                    
                    return hints[fieldName] || '';
                },

                getSlugSuggestions() {
                    return this.slugSuggestions || [];
                },

                selectSlugSuggestion(suggestion) {
                    this.formData.slug = suggestion;
                    this.slugSuggestions = [];
                    this.userModifiedSlug = true;
                },

                /**
                 * Check if step is valid
                 */
                isStepValid() {
                    const requiredFields = ['name', 'slug'];
                    
                    // Add conditionally required fields
                    if (this.isFieldRequired('email')) {
                        requiredFields.push('email');
                    }
                    if (this.isFieldRequired('phone')) {
                        requiredFields.push('phone');
                    }

                    // Check if all required fields are filled and valid
                    for (const field of requiredFields) {
                        if (!this.formData[field] || this.hasFieldError(field)) {
                            return false;
                        }
                    }

                    return true;
                }
            };
        }
    </script>
</body>
</html>